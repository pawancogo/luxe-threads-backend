<% content_for :title, "Edit Role: #{@role.name}" %>

<div class="admin-card">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="card-title mb-0">
      <i class="fas fa-edit me-2"></i>Edit Permissions for <%= @role.name %>
    </h1>
    <div>
      <%= link_to admin_rbac_role_path(@role), class: "btn btn-outline-primary me-2" do %>
        <i class="fas fa-eye me-2"></i>View Role
      <% end %>
      <%= link_to admin_rbac_roles_path, class: "btn btn-outline-secondary" do %>
        <i class="fas fa-arrow-left me-2"></i>Back
      <% end %>
    </div>
  </div>

  <%= form_with url: admin_rbac_role_path(@role), method: :patch, local: true do |f| %>
    <div class="card mb-4">
      <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-key me-2"></i>Select Permissions
          </h5>
          <div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAll()">
              <i class="fas fa-check-square me-1"></i>Select All
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAll()">
              <i class="fas fa-square me-1"></i>Deselect All
            </button>
          </div>
        </div>
      </div>
      <div class="card-body">
        <% if @permissions_by_category.any? %>
          <% @permissions_by_category.each do |category, permissions| %>
            <div class="mb-4 pb-4 border-bottom">
              <h6 class="text-primary mb-3">
                <i class="fas fa-folder me-2"></i><%= category.present? ? category : 'Uncategorized' %>
                <span class="badge bg-secondary ms-2"><%= permissions.count %></span>
                <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="toggleCategory('<%= category || 'uncategorized' %>')">
                  Toggle All
                </button>
              </h6>
              <div class="row" id="category-<%= category || 'uncategorized' %>">
                <% permissions.each do |permission| %>
                  <div class="col-md-6 mb-2">
                    <div class="form-check">
                      <%= check_box_tag "permission_ids[]", permission.id, @current_permission_ids.include?(permission.id), 
                          id: "permission_#{permission.id}", 
                          class: "form-check-input permission-checkbox",
                          data: { category: category || 'uncategorized' } %>
                      <%= label_tag "permission_#{permission.id}", class: "form-check-label" do %>
                        <strong class="small"><%= permission.name %></strong>
                        <br>
                        <code class="small text-muted"><%= permission.slug %></code>
                        <% if permission.description.present? %>
                          <br>
                          <small class="text-muted"><%= permission.description %></small>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        <% else %>
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>No permissions available.
          </div>
        <% end %>
      </div>
    </div>

    <div class="d-flex justify-content-end gap-2">
      <%= link_to "Cancel", admin_rbac_role_path(@role), class: "btn btn-outline-secondary" %>
      <%= f.submit "Update Permissions", class: "btn btn-primary" %>
    </div>
  <% end %>
</div>

<script>
function selectAll() {
  document.querySelectorAll('.permission-checkbox').forEach(cb => {
    cb.checked = true;
  });
}

function deselectAll() {
  document.querySelectorAll('.permission-checkbox').forEach(cb => {
    cb.checked = false;
  });
}

function toggleCategory(category) {
  const checkboxes = document.querySelectorAll(`.permission-checkbox[data-category="${category}"]`);
  const allChecked = Array.from(checkboxes).every(cb => cb.checked);
  checkboxes.forEach(cb => {
    cb.checked = !allChecked;
  });
}
</script>


