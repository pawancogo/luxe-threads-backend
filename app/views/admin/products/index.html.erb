<% content_for :title, "Product Management" %>

<div class="admin-card">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="card-title mb-0">
        <i class="fas fa-box me-2"></i>Product Management
      </h1>
      <p class="text-muted mb-0 mt-2">Manage products and their approval status</p>
    </div>
    <div>
      <%= link_to "Export CSV", admin_products_path(format: :csv, status: @status), class: "btn btn-sm btn-outline-success me-2" %>
      <% if super_admin? %>
        <%= link_to rails_admin_path, class: "btn btn-sm btn-outline-secondary", target: "_blank" do %>
          <i class="fas fa-database me-2"></i>View in RailsAdmin
        <% end %>
      <% end %>
    </div>
  </div>
  
  <!-- Status Tabs -->
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <%= link_to "All", admin_products_path(status: 'all'), 
          class: "nav-link #{'active' if @status == 'all'}" %>
    </li>
    <li class="nav-item">
      <%= link_to "Pending", admin_products_path(status: 'pending'), 
          class: "nav-link #{'active' if @status == 'pending'}" %>
    </li>
    <li class="nav-item">
      <%= link_to "Active", admin_products_path(status: 'active'), 
          class: "nav-link #{'active' if @status == 'active'}" %>
    </li>
    <li class="nav-item">
      <%= link_to "Rejected", admin_products_path(status: 'rejected'), 
          class: "nav-link #{'active' if @status == 'rejected'}" %>
    </li>
  </ul>
  
  <!-- Filters -->
  <%= render 'admin/shared/filters', records: @products %>
  
  <!-- Bulk Actions Bar -->
  <%= form_with url: bulk_approve_admin_products_path, method: :post, local: true, id: "bulk-form" do |f| %>
    <div id="bulk-actions-bar" class="card mb-3" style="display: none;">
      <div class="card-body py-2">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <span id="selected-count" class="badge bg-primary me-2">0</span>
            <span class="text-muted">product(s) selected</span>
          </div>
          <div class="btn-group">
            <button type="button" class="btn btn-sm btn-success" onclick="bulkAction('approve')">
              <i class="fas fa-check me-1"></i>Approve Selected
            </button>
            <button type="button" class="btn btn-sm btn-danger" onclick="bulkAction('reject')">
              <i class="fas fa-times me-1"></i>Reject Selected
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
              <i class="fas fa-times me-1"></i>Clear
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Products Table -->
    <div class="table-responsive">
      <table class="table table-hover table-sticky" data-table="products">
        <thead>
          <tr>
            <th width="40" class="sticky-col sticky-start sticky-header">
              <input type="checkbox" id="select-all" class="form-check-input" onchange="toggleSelectAll()">
            </th>
            <th>ID</th>
            <th>Product</th>
            <th>Supplier</th>
            <th>Category</th>
            <th>Price</th>
            <th>Status</th>
            <th>Created</th>
            <th class="sticky-col sticky-end sticky-header">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if @products.any? %>
            <% @products.each do |product| %>
              <tr data-id="<%= product.id %>" data-name="<%= product.name %>">
                <td class="sticky-col sticky-start sticky-cell">
                  <input type="checkbox" name="product_ids[]" value="<%= product.id %>" 
                         class="form-check-input product-checkbox" onchange="updateSelectedCount()">
                </td>
                <td><%= product.id %></td>
                <td>
                  <div class="d-flex align-items-center">
                    <% if product.product_images.any? %>
                      <%= image_tag product.product_images.first.image_url, 
                          class: "img-thumbnail me-2", style: "width: 50px; height: 50px; object-fit: cover;" %>
                    <% end %>
                    <div>
                      <strong><%= link_to product.name, admin_product_path(product), class: "text-decoration-none" %></strong>
                      <% if product.is_featured? %>
                        <span class="badge bg-warning ms-2">Featured</span>
                      <% end %>
                    </div>
                  </div>
                </td>
                <td><%= product.supplier_profile&.company_name || 'N/A' %></td>
                <td><%= product.category&.name || 'N/A' %></td>
                <td>
                  <% if product.product_variants.any? %>
                    â‚¹<%= number_with_delimiter(product.product_variants.first.price) %>
                  <% else %>
                    N/A
                  <% end %>
                </td>
                <td>
                  <span class="badge bg-<%= product.status == 'active' ? 'success' : product.status == 'pending' ? 'warning' : 'danger' %>">
                    <%= product.status %>
                  </span>
                </td>
                <td><%= product.created_at.strftime('%b %d, %Y') %></td>
                <td class="sticky-col sticky-end sticky-cell">
                  <div class="btn-group btn-group-sm">
                    <%= link_to admin_product_path(product), class: "btn btn-outline-primary", title: "View" do %>
                      <i class="fas fa-eye"></i>
                    <% end %>
                    <%= link_to edit_admin_product_path(product), class: "btn btn-outline-info", title: "Edit" do %>
                      <i class="fas fa-edit"></i>
                    <% end %>
                    <% if product.status == 'pending' %>
                      <%= link_to approve_admin_product_path(product), method: :patch, 
                                  class: "btn btn-outline-success", title: "Approve",
                                  data: { confirm: "Approve this product?" } do %>
                        <i class="fas fa-check"></i>
                      <% end %>
                      <%= link_to reject_admin_product_path(product), method: :patch, 
                                  class: "btn btn-outline-danger", title: "Reject",
                                  data: { confirm: "Reject this product?" } do %>
                        <i class="fas fa-times"></i>
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="9" class="text-center text-muted py-4">
                <i class="fas fa-box fa-3x mb-3 d-block"></i>
                No products found.
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
  
  <%= render 'admin/shared/pagination', collection: @products %>
</div>

<script>
function toggleSelectAll() {
  const selectAll = document.getElementById('select-all');
  const checkboxes = document.querySelectorAll('.product-checkbox');
  checkboxes.forEach(cb => cb.checked = selectAll.checked);
  updateSelectedCount();
}

function updateSelectedCount() {
  const checked = document.querySelectorAll('.product-checkbox:checked');
  const bulkBar = document.getElementById('bulk-actions-bar');
  const selectedCount = document.getElementById('selected-count');
  const selectAll = document.getElementById('select-all');
  
  if (checked.length > 0) {
    bulkBar.style.display = 'block';
    selectedCount.textContent = checked.length;
    selectAll.indeterminate = checked.length < document.querySelectorAll('.product-checkbox').length;
  } else {
    bulkBar.style.display = 'none';
    selectAll.checked = false;
    selectAll.indeterminate = false;
  }
}

function bulkAction(action) {
  const selected = document.querySelectorAll('.product-checkbox:checked');
  if (selected.length === 0) {
    alert('Please select at least one product');
    return;
  }
  
  const form = document.getElementById('bulk-form');
  const productIds = Array.from(selected).map(cb => cb.value);
  
  if (action === 'approve') {
    if (confirm(`Approve ${productIds.length} product(s)?`)) {
      form.action = '<%= bulk_approve_admin_products_path %>';
      form.submit();
    }
  } else if (action === 'reject') {
    const reason = prompt('Enter rejection reason:');
    if (reason) {
      form.action = '<%= bulk_reject_admin_products_path %>';
      const reasonInput = document.createElement('input');
      reasonInput.type = 'hidden';
      reasonInput.name = 'rejection_reason';
      reasonInput.value = reason;
      form.appendChild(reasonInput);
      form.submit();
    }
  }
}

function clearSelection() {
  document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
  document.getElementById('select-all').checked = false;
  updateSelectedCount();
}
</script>

<style>
  #bulk-actions-bar {
    background-color: #e7f1ff;
    border: 1px solid #b3d7ff;
  }

  .table-sticky thead th,
  .table-sticky tbody td {
    white-space: nowrap;
  }

  .table-sticky .sticky-col {
    position: sticky;
    z-index: 3;
  }

  .table-sticky .sticky-header {
    background-color: #f8f9fa !important;
  }

  .table-sticky .sticky-start {
    left: 0;
  }

  .table-sticky tbody .sticky-start {
    z-index: 2;
  }

  .table-sticky .sticky-cell {
    background-color: #fff !important;
  }

  .table-sticky .sticky-end {
    right: 0;
  }

  .table-sticky tbody .sticky-end {
    z-index: 2;
  }
</style>
