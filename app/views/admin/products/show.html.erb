<% content_for :title, "Product - #{@product.name}" %>

<div class="admin-card mb-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="card-title mb-0">
        <i class="fas fa-box me-2"></i><%= @product.name %>
      </h1>
      <p class="text-muted mb-0 mt-2">Product Details & Variants</p>
    </div>
    <div>
      <%= link_to "Back to Products", admin_products_path, class: "btn btn-outline-secondary" %>
      <%= link_to "Edit", edit_admin_product_path(@product), class: "btn btn-primary" %>
    </div>
  </div>
  
  <div class="row">
    <div class="col-md-8">
      <!-- Product Images -->
      <% if @product_variants.any? && @product_variants.first.product_images.any? %>
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0">Product Images</h5>
          </div>
          <div class="card-body">
            <div class="row g-2">
              <% @product_variants.first.product_images.limit(4).each do |image| %>
                <div class="col-md-3">
                  <%= image_tag image.image_url, class: "img-fluid rounded", style: "max-height: 150px; object-fit: cover; width: 100%;" %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
      
      <!-- Product Details -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Product Details</h5>
        </div>
        <div class="card-body">
          <table class="table table-bordered">
            <tr>
              <th width="30%">ID</th>
              <td><%= @product.id %></td>
            </tr>
            <tr>
              <th>Name</th>
              <td><%= @product.name %></td>
            </tr>
            <tr>
              <th>Description</th>
              <td><%= simple_format(@product.description) %></td>
            </tr>
            <tr>
              <th>Supplier</th>
              <td><%= @product.supplier_profile&.company_name || 'N/A' %></td>
            </tr>
            <tr>
              <th>Category</th>
              <td><%= @product.category&.name || 'N/A' %></td>
            </tr>
            <tr>
              <th>Brand</th>
              <td><%= @product.brand&.name || 'N/A' %></td>
            </tr>
            <tr>
              <th>Status</th>
              <td>
                <span class="badge bg-<%= @product.status == 'active' ? 'success' : @product.status == 'pending' ? 'warning' : 'danger' %>">
                  <%= @product.status %>
                </span>
              </td>
            </tr>
            <tr>
              <th>Featured</th>
              <td>
                <% if @product.is_featured? %>
                  <span class="badge bg-warning">Yes</span>
                <% else %>
                  <span class="badge bg-secondary">No</span>
                <% end %>
              </td>
            </tr>
            <% if @product.rejection_reason.present? %>
              <tr>
                <th>Rejection Reason</th>
                <td class="text-danger"><%= @product.rejection_reason %></td>
              </tr>
            <% end %>
            <tr>
              <th>Created At</th>
              <td><%= @product.created_at.strftime('%B %d, %Y at %I:%M %p') %></td>
            </tr>
          </table>
        </div>
      </div>
      
      <!-- Product Variants -->
      <% if @product_variants.any? %>
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Product Variants</h5>
            <span class="badge bg-primary"><%= @product_variants.total_count %> total</span>
          </div>
          <div class="card-body">
            <!-- Variant Filters -->
            <%= render 'variant_filters' %>
            
            <div class="table-responsive">
              <table class="table table-sm table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>SKU</th>
                    <th>Size</th>
                    <th>Color</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <% @product_variants.each do |variant| %>
                    <% 
                      # Get size and color from variant attributes
                      size_attr = variant.product_variant_attributes.joins(attribute_value: :attribute_type)
                                        .where(attribute_types: { name: 'Size' })
                                        .first&.attribute_value&.value
                      color_attr = variant.product_variant_attributes.joins(attribute_value: :attribute_type)
                                         .where(attribute_types: { name: 'Color' })
                                         .first&.attribute_value&.value
                    %>
                    <tr data-id="<%= variant.id %>" data-sku="<%= variant.sku %>">
                      <td><%= variant.id %></td>
                      <td><strong><%= variant.sku %></strong></td>
                      <td><%= size_attr || '<span class="text-muted">N/A</span>'.html_safe %></td>
                      <td><%= color_attr || '<span class="text-muted">N/A</span>'.html_safe %></td>
                      <td>â‚¹<%= number_with_delimiter(variant.price) %></td>
                      <td>
                        <%= variant.stock_quantity %>
                        <% if variant.is_low_stock? %>
                          <span class="badge bg-warning ms-1">Low Stock</span>
                        <% end %>
                        <% if variant.out_of_stock? %>
                          <span class="badge bg-danger ms-1">Out of Stock</span>
                        <% end %>
                      </td>
                      <td>
                        <span class="badge bg-<%= variant.is_available? ? 'success' : 'secondary' %>">
                          <%= variant.is_available? ? 'Available' : 'Unavailable' %>
                        </span>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            
            <!-- Variant Pagination -->
            <% if @product_variants.respond_to?(:current_page) %>
              <div class="d-flex justify-content-between align-items-center mt-3">
                <div class="text-muted">
                  <% if @product_variants.respond_to?(:total_count) %>
                    Showing <%= (@product_variants.current_page - 1) * @product_variants.limit_value + 1 %> to 
                    <%= [@product_variants.current_page * @product_variants.limit_value, @product_variants.total_count].min %> of 
                    <%= @product_variants.total_count %> variants
                  <% end %>
                </div>
                <div>
                  <%= paginate @product_variants, param_name: 'variant_page', params: { id: @product.id } if defined?(Kaminari) %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
    
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Actions</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <% if @product.status == 'pending' %>
              <%= link_to "Approve Product", approve_admin_product_path(@product), method: :patch, 
                          class: "btn btn-success",
                          data: { confirm: "Approve this product?" } %>
              <%= link_to "Reject Product", reject_admin_product_path(@product), method: :patch, 
                          class: "btn btn-danger",
                          data: { confirm: "Reject this product?" } %>
            <% elsif @product.status == 'active' %>
              <button class="btn btn-outline-secondary" disabled>Product is Active</button>
            <% elsif @product.status == 'rejected' %>
              <%= link_to "Approve Product", approve_admin_product_path(@product), method: :patch, 
                          class: "btn btn-success",
                          data: { confirm: "Approve this product?" } %>
            <% end %>
            
            <%= link_to "Edit Product", edit_admin_product_path(@product), class: "btn btn-primary" %>
            <%= link_to "Delete Product", admin_product_path(@product), method: :delete, 
                        class: "btn btn-outline-danger",
                        data: { confirm: "Are you sure? This action cannot be undone." } %>
            <%= link_to "View in RailsAdmin", rails_admin_path, class: "btn btn-outline-secondary mt-2", target: "_blank" %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
